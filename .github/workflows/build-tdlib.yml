name: Build TDLib JNI (.so)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build libtdjni.so (all ABIs)
        run: |
          set -e

          echo "=== Install dependencies ==="
          sudo apt update
          sudo apt install -y git cmake build-essential openjdk-17-jdk wget unzip

          echo "=== Install Android NDK ==="
          NDK_VERSION=r26d
          wget -q https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip
          unzip -q android-ndk-${NDK_VERSION}-linux.zip
          export ANDROID_NDK=$PWD/android-ndk-${NDK_VERSION}

          echo "=== Clone TDLib ==="
          git clone https://github.com/tdlib/td.git
          cd td

          echo "=== Build for all ABIs ==="
          for ABI in armeabi-v7a arm64-v8a x86 x86_64; do
            echo ">>> Building $ABI"
            mkdir build-$ABI && cd build-$ABI

            cmake .. \
              -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK/build/cmake/android.toolchain.cmake \
              -DANDROID_ABI=$ABI \
              -DANDROID_PLATFORM=android-21 \
              -DCMAKE_BUILD_TYPE=Release \
              -DTD_ENABLE_JNI=ON

            cmake --build . --target tdjni -- -j2
            cd ..
          done

          echo "=== Collect outputs ==="
          mkdir -p ../tdlib-android/{arm64-v8a,armeabi-v7a,x86,x86_64}
          cp build-arm64-v8a/libtdjni.so ../tdlib-android/arm64-v8a/
          cp build-armeabi-v7a/libtdjni.so ../tdlib-android/armeabi-v7a/
          cp build-x86/libtdjni.so ../tdlib-android/x86/
          cp build-x86_64/libtdjni.so ../tdlib-android/x86_64/

      - name: Upload .so files
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-android-so
          path: tdlib-android/
